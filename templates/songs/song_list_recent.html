{% load session_filters %}
{% load thumbnail %}

{% for song in page_obj %}


<div class="container p-0 mt-1 px-3">
    <div class="row justify-content-between align-items-center bg-dark p-3 shadow rounded-2 " style="border: 1px solid hsla(0, 0%, 100%, .3);">
        {% thumbnail song.thumbnail "70x70" crop="center" as thumb %}
            <a href="{% url 'songs:song_detail' song.id %}" style="padding: 0; display: inline; width: 70px;"><img src="{{ thumb.url }}" alt="" style="width: 70px; height: 70px; padding: 0;"></a>
        {% endthumbnail %}
        <div class="col">
            {% if forloop.counter <= 3 %} 
                <span style="margin-right: 2px; color: yellow;">New</span>
            {% endif %}
            <a class="text-decoration-none " href="{% url 'songs:song_detail' song.id %}">
                <!-- 노래 세부 내용 페이지로 링크 -->
                <h5 class="text-white mb-0">{{ song.title }}</h5>
                <small class="fs-6" style="color: #888888;">
                    <a class="text-decoration-none " style="color: #888;"  href="{% url 'sellers:seller_artist' song.seller.user.id %}">{{ song.seller }}</a>
                </small>
            </a>
        </div>
        <div class="col">
            <div>
                <a class="btn btn-outline-light me-2 text-white" style="cursor: pointer;" data-id="{{ song.id }}" onclick="showLyrics(this.getAttribute('data-id'))">가사 보기</a>
            </div>
        </div>
        <div class="col-auto d-flex align-items-center">
            <audio controls class="me-3" controlsList="nodownload">
                <source src="{{ song.mp3.url }}" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>

            {% if user.is_authenticated %}
            <!-- 여기서 templatetags 로 song.id를 넘겨서 구매한 노래인지 아닌 지 확인 하는 거를 체크-->
            {% is_purchased user song.id as purchased %}
            {% is_added_to_cart user song.id as added %}
            
                <!-- 찜 버튼 -->
                {% if not added %}
                    <button id="add-btn-{{song.id}}" type="button" class="btn btn-outline-light me-2"
                        onclick="addToCart('{{song.id}}');">찜하기</button>
                {% else %}
                    <button id="remove-btn-{{song.id}}" type="button" class="btn btn-outline-danger me-2"
                        onclick="removeFromCart('{{song.id}}');">찜 취소</button>
                {% endif %}
                {% if not purchased %}
                <!-- 다운로드 버튼 -->
                <form action="{% url 'payments:payment_pay' song.id %}"
                    onsubmit="return confirmPurchase('{{ song.title|escapejs }}')">
                    <button class="btn btn-outline-light me-2" type="submit" onclick="">구매하기</button>
                </form>
                {% else %}
                <a href="{{ song.mp3.url }}" download="{{ song.title }}.mp3">
                    <button class="btn btn-outline-light me-2">다운로드</button>
                </a>
                {% endif %}
            {% else %}
                <button type="button" class="btn btn-outline-light me-2" onclick="gotoLogin();">찜하기</button>
                <button class="btn btn-outline-light me-2" type="submit" onclick="gotoLogin();">구매하기</button>
            {% endif %}
        </div>
    </div>
</div>
{% endfor %}




